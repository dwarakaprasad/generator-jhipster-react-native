#!/usr/bin/env bash

set -euo pipefail
# based on https://github.com/infinitered/ignite/blob/a7eade35a46e19bfa7bb28c2aa595d070e79a0a0/boilerplate/bin/downloadExpoApp.sh
APP_PATH=./e2e/Exponent.apk

if [ ! -d $APP_PATH ]; then
  echo "First time running Detox -- downloading Expo client app"

  # Sanity check
  if [ ! -f "package.json" ]; then
    echo "Oops - run this command from your project's root folder" >>/dev/stderr
    exit 1
  fi

  # Make the app dir (this'll also make sure we already have the bin directory)
  mkdir $APP_PATH

  # query expo.io to find most recent ipaUrl
  IPA_URL=$(curl --silent --show-error https://expo.io/--/api/v2/versions | jq -r ".androidUrl")

  # download .apk
  TMP_PATH=./Exponent.apk
  curl --silent --show-error --output $TMP_PATH $IPA_URL

  # move apk into APP_PATH
  mv $TMP_PATH $APP_PATH
fi
